name: RDP

on:
  workflow_dispatch:

jobs:
  setup-rdp:
    runs-on: windows-latest
    timeout-minutes: 3600
    env:
      # اضبط secret في إعدادات الريبو (do NOT put raw key in file)
      TAILSCALE_AUTHKEY: ${{ secrets.TAILSCALE_AUTHKEY }}

    steps:
      - name: Enable RDP and Firewall Rules
        shell: pwsh
        run: |
          Write-Host "== Enabling Remote Desktop =="
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name 'fDenyTSConnections' -Value 0
          Enable-NetFirewallRule -DisplayGroup "Remote Desktop"

      - name: Create RDP User
        shell: pwsh
        run: |
          $username = "RDPUser"
          $chars = ([char[]](33..126))
          $password = -join ((1..14) | ForEach-Object { $chars | Get-Random })
          $securePass = ConvertTo-SecureString $password -AsPlainText -Force

          if (Get-LocalUser -Name $username -ErrorAction SilentlyContinue) {
            Set-LocalUser -Name $username -Password $securePass
          } else {
            New-LocalUser -Name $username -Password $securePass -FullName "RDP User" -Description "Temporary RDP user"
          }

          Add-LocalGroupMember -Group "Remote Desktop Users" -Member $username
          Write-Host "=== LOGIN INFO ==="
          Write-Host "Username: $username"
          Write-Host "Password: $password"
          Write-Host "==================="
          # خزّن القيم في متغيّر environment للوصول لها بخطوة لاحقة
          echo "USERNAME=$username" >> $env:GITHUB_ENV
          echo "PASSWORD=$password" >> $env:GITHUB_ENV

      - name: Install Tailscale (silent)
        shell: pwsh
        run: |
          Write-Host "== Installing Tailscale =="
          $installerUrl = "https://pkgs.tailscale.com/stable/tailscale-setup-latest.exe"
          $installer = "$env:TEMP\tailscale-setup.exe"
          Invoke-WebRequest -Uri $installerUrl -OutFile $installer -UseBasicParsing
          Start-Process -FilePath $installer -ArgumentList "/S" -NoNewWindow -Wait
          Write-Host "== Installer finished =="
          Start-Sleep -Seconds 3

      - name: Locate tailscale executable and start service if needed
        shell: pwsh
        run: |
          # حاول المسار الافتراضي أول
          $defaultPath = Join-Path -Path ${env:ProgramFiles} -ChildPath "Tailscale IPN\tailscale.exe"
          $exe = $null
          if (Test-Path $defaultPath) {
            $exe = $defaultPath
          } else {
            # بحث سريع في Program Files و Program Files (x86)
            $candidates = Get-ChildItem 'C:\Program Files','C:\Program Files (x86)' -Recurse -Filter "tailscale.exe" -ErrorAction SilentlyContinue | Select-Object -First 1
            if ($candidates) { $exe = $candidates.FullName }
          }

          if (-not $exe) {
            Write-Error "tailscale.exe not found after install. Listing Program Files for debugging."
            Get-ChildItem 'C:\Program Files' -Depth 2 | Select-Object FullName | Out-String | Write-Host
            exit 1
          } else {
            Write-Host "Found tailscale at: $exe"
          }

          # حاول تشغيل الخدمة لو موجودة، وإلا نكتفي باستدعاء الـ exe مباشرة
          $svc = Get-Service -Name Tailscale -ErrorAction SilentlyContinue
          if ($svc) {
            if ($svc.Status -ne 'Running') {
              Start-Service -Name Tailscale
              Start-Sleep -Seconds 2
            }
            Write-Host "Tailscale service status: $(Get-Service -Name Tailscale).Status"
          }

          # خزّن المسار لاستخدامه بعدين
          echo "TAILSCALE_EXE=$exe" >> $env:GITHUB_ENV

      - name: Login / up to Tailscale
        shell: pwsh
        run: |
          $exe = $env:TAILSCALE_EXE
          if (-not (Test-Path $exe)) {
            Write-Error "tailscale executable missing: $exe"
            exit 1
          }

          if (-not $env:TAILSCALE_AUTHKEY) {
            Write-Error "No TAILSCALE_AUTHKEY provided. Set it in repo secrets."
            exit 1
          }

          Write-Host "== Running: tailscale up =="
          # استخدم authkey من env (لن يظهر في الـ logs لأنه سري)
          & $exe up --authkey="$env:TAILSCALE_AUTHKEY" --hostname="github-rdp" --accept-routes=false

          # انتظر شوية عشان يثبت IP
          Start-Sleep -Seconds 2

          # جلب IP الخاص بـ Tailscale
          $ip = (& $exe ip -4) -join " "
          if ($ip) {
            Write-Host "Tailscale IP: $ip"
            echo "TS_IP=$ip" >> $env:GITHUB_ENV
          } else {
            Write-Warning "لم أحصل على IP من tailscale ip -4"
          }

      - name: Display Connection Info
        shell: pwsh
        run: |
          Write-Host ""
          Write-Host "==============================="
          Write-Host "✅ RDP Setup Complete!"
          Write-Host "Tailscale IP: $env:TS_IP"
          Write-Host "Username: $env:USERNAME"
          Write-Host "Password: $env:PASSWORD"
          Write-Host "==============================="
          Write-Host ""
          Write-Host "➡️  افتح تطبيق Tailscale على جهازك وسجّل بنفس الحساب."
          Write-Host "➡️  بعد كده افتح RDP للـ IP الظاهر فوق باستخدام بيانات الدخول."
